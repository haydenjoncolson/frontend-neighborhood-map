<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hayden Colson's Neighborhood Map</title>
    <style type="text/css">
      html, body, #map {
        height: 100%;
        width: 100%;
        position: absolute;
        margin: 0;
        padding: 0;
      }
      #side-search {
        height: 50%;
        width: 50%;
        background-color: white;
        position: absolute;
        text-align: center;
      }
      #filter {
        width: 90%;
        margin: 0;
      }
      #resultList {
        text-align: left;
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .resultItem {
        margin: 1em;
        border-bottom-style: solid;
        padding-bottom: 1em
      }
      @media (min-width: 660px) {
        #side-search {
          width: 25%;
        }
      }



    </style>
    <script src="js/knockout-3.4.1.js"></script>

  </head>
  <body>

    <div id="map"></div>
    <div id="side-search">
      <h3>Filter Nearby Tacos</h3>
      <input id="filter" type="search" data-bind="textInput: query">
      <ul id="resultList" data-bind="foreach: filter">
        <li class="resultItem" data-bind="text: title, click: $root.listClick"></li>
      </ul>
    </div>

<script>
var map,
    largeInfowindow,
    styles; // add map style if wanted

// Create a new blank array for all the listing markers.
var markers = [];

var CLIENT_ID = "DMLIWBSJSUZ13YSSHU1HUCTQ1AQVINBJVSSU5WB55PBGMOGB",
    CLIENT_SECRET = "WONXX20DUNUG4HQ2P0RCAMIMLJKWYAB3F0JXSCGIORVFS4MI";

var viewModel;

var locations = [
  {title: 'Taco Plus', location: {lat: 34.039792, lng: -118.462749}, id: '4aefb029f964a520e4d921e3'},
  {title: "Pili's Tacos", location: {lat: 34.041434, lng: -118.460919}, id: '4bce16dacc8cd13a15b9c3cf'},
  {title: "Tacos Punta Cabras", location: {lat: 34.031109, lng: -118.477382}, id: '51146ef8e4b0bdd77b8c1af7'},
  {title: "Mondo Taco", location: {lat: 34.026732, lng: -118.474803}, id: '500b50ebe4b084af1e3a8420'},
  {title: 'Tacoteca', location: {lat: 34.035087, lng: -118.478183}, id: '548bb3bf498e486d0cc82af9'}
];
function initMap() {
    // Constructor creates a new map - only center and zoom are required.
    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 34.038004, lng: -118.467396},
      zoom: 13
    });

    largeInfowindow = new google.maps.InfoWindow();
    var bounds = new google.maps.LatLngBounds();

    // The following group uses the location array to create an array of markers on initialize.
    for (var i = 0; i < locations.length; i++) {
      // Get the position from the location array.
      var position = locations[i].location;
      var title = locations[i].title;
      // Create a marker per location, and put into markers array.
      var marker = new google.maps.Marker({
        map: map,
        position: position,
        title: title,
        animation: google.maps.Animation.DROP,
        id: i
      });
      // Push the marker to our array of markers.
      markers.push(marker);

      locations[i].marker = marker;




      // Create an onclick event to open an infowindow at each marker.
      marker.addListener('click', function() {
        populateInfoWindow(this, largeInfowindow);
      });
      bounds.extend(markers[i].position);

      //     Foursqaure included in loop
              console.log(locations[i]);


    }
    // Extend the boundaries of the map for each marker
    map.fitBounds(bounds);
  }



  // This function populates the infowindow when the marker is clicked. We'll only allow
  // one infowindow which will open at the marker that is clicked, and populate based
  // on that markers position.
  function populateInfoWindow(marker, infowindow) {
    // Check to make sure the infowindow is not already opened on this marker.
    if (infowindow.marker != marker) {
      infowindow.marker = marker;
      infowindow.setContent('<div>' + marker.title + '</div>');
      infowindow.open(map, marker);
      // Make sure the marker property is cleared if the infowindow is closed.
      // infowindow.addListener('closeclick',function(){
      //   infowindow.setMarker(null);
      // });
    }
  }



// Model
var Restaurant = function(data) {
  var self = this;
  self.title = data.title;
  self.location = ko.observable(data.location);
  self.display = ko.observable(true);
  // self.marker

  // self.yelp data rrom yelp api (rating)
}


// Class
// Constructor function
// Function expression
// new operator
ViewModel = function() {
  var self = this;
  self.query = ko.observable("");
  self.locations =  ko.observableArray(locations);
  // self.filteredResults = ko.observableArray();
  // // For each restaurant, push to filteredResults
  // var restaurant;
  // for (var i = 0; i < locations.length; i++) {
  //   restaurant = new Restaurant(locations[i]);
  //   self.filteredResults.push(restaurant);
  // }


    //filter the items using the filter text
  self.filter = ko.computed(function() {
        var filter = self.query().toLowerCase();
        if (!filter) {
            return self.locations();
        } else {
            var newArray = ko.utils.arrayFilter(self.locations(), function(location) {
                //return location.title.toLowerCase();
                if (location.title.toLowerCase().indexOf(filter) === -1) {
                  return false;
                } else {
                  return true;
                }
            });

            return newArray;
        }
    }, viewModel);

    self.listClick = function(restaurant) {
      populateInfoWindow(restaurant.marker, largeInfowindow);
    };

    self.foursquare = function() {
//    Turn into loop
      $.ajax({
            url:'https://api.foursquare.com/v2/venues/search',
            dataType: 'json',
            data: 'limit=1' +
                '&ll=34.038004,-118.467396' +
                '&query=' + location[i].title +
                '&client_id='+ CLIENT_ID +
                '&client_secret='+ CLIENT_SECRET +
                '&v=20130815',

            async: true,

            success: function(data) {
              console.log("success")
            },
            error: function(e) {
      				console.log("foursquare error");
      		  }
        });
      };




  };

  //http://knockoutjs.com/documentation/computedObservables.html
//  self.writeToConsole = ko.computed(function() {
    //console.log(self.query());
  //});






   // Instantiate an instance of ViewModel
   // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/new
   viewModel = new ViewModel();

   // Activate Knockout
   ko.applyBindings(viewModel);


</script>

    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBw_WkVDGpVvg7_Peqts6LWTHtC4-qS1lw&v=3&callback=initMap">
    </script>

  </body>
</html>
